<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>DDT Experiment Setup</title>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        label { display: block; margin-bottom: 0.5em; }
    </style>
</head>
<body>
    <h1>Delayed Discounting Task</h1>
    <form action="{{ url_for('start') }}" method="post">
        <label>Subject ID:
            <input type="number" name="subject_id" id="subject_id" readonly placeholder="Auto-assigned">
        </label>
        <label>Session:
            <input type="number" name="session" value="1" required readonly>
        </label>
        <label>Number of train trials:
            <input type="number" name="num_train_trials" value="5" required readonly>
        </label>
        <label>Number of main trials:
            <input type="number" name="num_main_trials" value="40" required readonly>
        </label>
        <label>
            <input type="checkbox" id="show_tutorial_display" checked disabled>
            <input type="hidden" name="show_tutorial" value="1">
            Show tutorial
        </label>
        <button type="submit">Start Experiment</button>
    </form>
    
    <script>
        // Parse query string parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Fields to check for query parameters
        const fields = ['subject_id', 'session', 'num_train_trials', 'num_main_trials', 'show_tutorial'];
        
        // Check for setup parameter first
        const setupParam = urlParams.get('setup');
        let setupValues = null;
        if (setupParam) {
            const parts = setupParam.split(',');
            if (parts.length === 5) {
                setupValues = {
                    subject_id: parts[0].trim(),
                    session: parts[1].trim(),
                    num_train_trials: parts[2].trim(),
                    num_main_trials: parts[3].trim(),
                    show_tutorial: parts[4].trim() === '1'
                };
            }
        }
        
        // Only populate subject ID if explicitly provided via query parameters
        function handleSubjectId() {
            const subjectIdParam = urlParams.get('subject_id');
            const hasSetupSubjectId = setupValues && setupValues.subject_id;
            
            if (subjectIdParam !== null || hasSetupSubjectId) {
                // Only set if explicitly provided via URL parameters
                const subjectId = hasSetupSubjectId ? setupValues.subject_id : subjectIdParam;
                document.getElementById('subject_id').value = subjectId;
            }
            // Otherwise leave empty - will be auto-assigned on form submission
        }
        
        // Handle subject ID on page load
        handleSubjectId();
        
        fields.forEach(fieldName => {
            let value;
            
            // Use setup values if available, otherwise use individual query parameters
            if (setupValues && setupValues.hasOwnProperty(fieldName)) {
                value = setupValues[fieldName];
            } else {
                const paramValue = urlParams.get(fieldName);
                value = paramValue !== null ? paramValue : null;
            }
            
            if (value !== null) {
                if (fieldName === 'show_tutorial') {
                    // Handle special case: display checkbox + hidden field
                    const isChecked = value === true || value.toString().toLowerCase() === 'true' || value === '1';
                    document.getElementById('show_tutorial_display').checked = isChecked;
                    document.querySelector('[name="show_tutorial"]').value = isChecked ? '1' : '0';
                } else {
                    const element = document.querySelector(`[name="${fieldName}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value === true || value.toString().toLowerCase() === 'true' || value === '1';
                        } else {
                            element.value = value;
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
